<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>airoViz</title>

		<!-- Libs -->
		<script type="text/javascript" src="../lib/d3/d3.js"></script>
		<script type="text/javascript" src="../lib/underscore/underscore-min.js"></script>
		<script src="../lib/lodash/lodash.js"></script>
		<script type="text/javascript" src="../lib/jquery/jquery-2.1.0.min.js"></script>

		<!-- Src -->
		<script type="text/javascript" src="../utils.js"></script>
		<script type="text/javascript" src="../js/graph.js"></script>
		<script type="text/javascript" src="../js/Tooltip.js"></script>
		<script type="text/javascript" src="../js/colorBrewer.js"></script>
		<link rel="stylesheet" href="css/style.css">
	</head>
	<body>
		<script type="text/javascript">
			var intervalID;
		  $(document).ready(function() {

					app.width = $(window).width();
					app.height=$(window).height();
					myNetwork = Network();

					//TODO: minNetworks to GUI
					var minNetworks = 15	;
					if(app.layout == "Distance" ||app.layout == "ConnectionsRealTime"  ){
						var time = setDuration(app.hours,app.minutes,app.seconds);
						url = 'http://'+app.server+'/lastseen?lastseen='+time;
					}
					else if(app.layout == "Connections"){
						url = 'http://'+app.server+'/clients?minNetworks='+minNetworks;
					}

					// console.log(url);
					$.ajax({
						dataType: 'jsonp',
						url: url,
						type: 'GET',
							success: function(postData) {

								// Setup Network
								// console.log(postData);
								myNetwork('#vis',postData);
								myNetwork.updateData(postData);


							},

							error: function(err) {
								console.log("GET failed ");
								console.log(err);
							}
					});

					if(app.layout == "Distance" ||app.layout == "ConnectionsRealTime"  ){
						console.log(app.interval);
						intervalID = setInterval(myInterval,app.interval);
					}


					function activate(group, link){
						d3.selectAll("#"+group+" a").classed({'active': false});
						d3.select("#"+group+" #"+link).attr("id",link).classed('active', true)
					}


					d3.selectAll("#nodeColor a").on("click",function (d){
						newColor = d3.select(this).attr("id");
						activate("nodeColor", newColor);
						myNetwork.toggleNodeColor(newColor);

					});

					d3.selectAll("#layouts a").on("click",function (d){
						newLayout = d3.select(this).attr("id");

						activate("layouts", newLayout);
						console.log("newLayout :" + newLayout)
						myNetwork.toggleLayout(newLayout);

					});

				});
				var myInterval = function(){
					console.log("here")
					var time = setDuration(app.hours,app.minutes,app.seconds);
					url = 'http://'+app.server+'/lastseen?lastseen='+time;
					console.log(url);

					$.ajax({
						dataType: 'jsonp',
						url: url,
						type: 'GET',
							success: function(postData) {
								myNetwork.updateData(postData);
							},

							error: function(err) {
								console.log("GET failed ");
								console.log(err);
							}
					});
				}

		</script>
		<div id="main" role="main">
			<div id='vis'></div>
		</div>
		<div id="controls">
      <div id="nodeColor" class="control">
        <h3 >Node color</h3>
        <a id="Kind"  >Type</a>
				<a id="Power" class="active" >Power</a>
      </div>

			<div id="layouts" class="control">
				<h3 >Node Layout</h3>
				<a id="ConnectionsRealTime" class="active" >Connections RealTime</a>
				<a id="Distance"  >Distance</a>
				<a id="Connections" >Connections</a>
			</div>
			<div id="search_section" class="control">
					<form id="bssidForm" action="/client"  method="get">
						<h3 class="control">Search By Mac </h3>
						<input type="text" class="text-input" name="bssid" />
					</form>
					<button id = "macADD">Search</button>

				<script>
				$("#macADD").click(function(){
					// var bssidReqUrl = 'http://'+app.server+'/intersections?bssid=';
					var bssidReqUrl = 'http://localhost:8080/client?bssid=';
					bssidReqUrl+=encodeURIComponent($('#bssidForm input').val())
					console.log(bssidReqUrl);
					$.ajax({
						dataType: 'jsonp',
						url: bssidReqUrl,
						type: 'GET',
							success: function(postData) {
								// Setup Network
								if(postData.length >0){
										console.log(postData)
										$("#macADD").addClass("active");
										$("#RealTime").removeClass("active");
										// console.log("clearing interval " + intervalID);
										// clearInterval(intervalID);
										myNetwork.updateNode(postData[0]);
										// myNetwork.updateData(postData);
										myNetwork.toggleLayout("Connections");
								}
							},

							error: function(err) {
								console.log("GET failed ");
								console.log(err);
							}
					});

				});
				</script>
			</div>
			<div id="search_probed" class="control">
					<form id="probedForm" action="/probed"  method="get">
						<h3 class="control">Search By Network </h3>
						<input type="text" class="text-input" name="essid" />
					</form>
					<button id = "probedNetworks">Search</button>

				<script>
				$("#probedNetworks").click(function(){

					var probedReqUrl = 'http://localhost:8080/probed?essid=';
					probedReqUrl+=encodeURIComponent($('#probedForm input').val())
					console.log(probedReqUrl);
					$.ajax({
						dataType: 'jsonp',
						url: probedReqUrl,
						type: 'GET',
							success: function(postData) {
								// Setup Network
								if(postData.length >0){
										console.log(postData)
										$("#probedNetworks").addClass("active");
										$("#RealTime").removeClass("active");
										$("#macADD").removeClass("active");
										console.log("clearing interval " + intervalID);
										clearInterval(intervalID);
										myNetwork.updateData(postData);
										myNetwork.toggleLayout("Connections");
								}
							},

							error: function(err) {
								console.log("GET failed ");
								console.log(err);
							}
					});

				});
				</script>
			</div>


		</div>


	</body>
</html>
